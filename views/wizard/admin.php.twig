{% extends "/templates/wizard.php.twig" %}

{% block steps %}
    <div class="flex items-center justify-center gap-2 mb-4 text-center">
        <div class="flex flex-col items-center min-w-[70px]">
            <span class="bg-blue-200 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center font-bold">1</span>
            <span class="text-xs mt-1 text-blue-700 whitespace-nowrap">Base de datos</span>
        </div>
        <span class="w-6 h-1 bg-blue-200 rounded"></span>
        <div class="flex flex-col items-center min-w-[70px]">
            <span class="bg-blue-200 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center font-bold">2</span>
            <span class="text-xs mt-1 text-blue-700 whitespace-nowrap">Restaurante</span>
        </div>
        <span class="w-6 h-1 bg-blue-500 rounded"></span>
        <div class="flex flex-col items-center min-w-[70px]">
            <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">3</span>
            <span class="text-xs mt-1 text-blue-700 font-semibold whitespace-nowrap">Administrador</span>
        </div>
        <span class="w-6 h-1 bg-blue-200 rounded"></span>
        <div class="flex flex-col items-center min-w-[70px]">
            <span class="bg-blue-200 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center font-bold">4</span>
            <span class="text-xs mt-1 text-blue-700 whitespace-nowrap">Stripe</span>
        </div>
        <span class="w-6 h-1 bg-blue-200 rounded"></span>
        <div class="flex flex-col items-center min-w-[70px]">
            <span class="bg-blue-200 text-blue-700 rounded-full w-8 h-8 flex items-center justify-center font-bold">5</span>
            <span class="text-xs mt-1 text-blue-700 whitespace-nowrap">Características</span>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="flex flex-col items-center justify-center min-h-[60vh] w-full">
        <div class="w-full max-w-lg ">
            <div class="flex flex-col items-center mb-6">
                <span class="bg-blue-100 rounded-full p-3 mb-2">
                    <i data-feather="user-check" class="w-8 h-8 text-blue-600"></i>
                </span>
                <h1 class="text-2xl font-extrabold text-blue-700 drop-shadow border-b-4 border-blue-500 inline-block pb-1 mb-2">Administrador</h1>
                <p class="text-gray-600 text-center">Configura la cuenta principal de administración para tu restaurante.</p>
            </div>
            <form id="adminForm" action="/admin" method="post" class="space-y-5">
                <div id="formError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"></div>
                <div class="flex items-center gap-2 mb-2">
                    <i data-feather="user" class="w-5 h-5 text-blue-400"></i>
                    <h2 class="text-lg font-bold text-blue-700">Datos de acceso</h2>
                </div>
                <p class="mb-4 text-gray-500 text-sm">Por favor, proporciona las credenciales para la cuenta del administrador.</p>

                <div>
                    <label for="admin_username" class="text-sm font-medium text-gray-700 mb-1 flex items-center gap-1">
                        <i data-feather="user" class="w-4 h-4 text-blue-400"></i>
                        Nombre
                    </label>
                    <input type="text" id="admin_username" name="admin_username" required class="mt-1 block w-full border-blue-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base px-4 py-2">
                </div>

                <div>
                    <label for="admin_email" class="text-sm font-medium text-gray-700 mb-1 flex items-center gap-1">
                        <i data-feather="mail" class="w-4 h-4 text-blue-400"></i>
                        Email
                    </label>
                    <input type="email" id="admin_email" name="admin_email" required class="mt-1 block w-full border-blue-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base px-4 py-2">
                </div>

                <div>
                    <label for="admin_password" class="text-sm font-medium text-gray-700 mb-1 flex items-center gap-1">
                        <i data-feather="lock" class="w-4 h-4 text-blue-400"></i>
                        Contraseña
                    </label>
                    <input type="password" id="admin_password" name="admin_password" required class="mt-1 block w-full border-blue-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base px-4 py-2">
                    <ul class="text-xs text-gray-500 mt-1 ml-2 list-disc list-inside">
                        <li>Mínimo 8 caracteres</li>
                        <li>Al menos una mayúscula</li>
                        <li>Al menos una minúscula</li>
                        <li>Al menos un número</li>
                        <li>Al menos un carácter especial</li>
                    </ul>
                </div>

                <div>
                    <label for="admin_password_confirm" class="text-sm font-medium text-gray-700 mb-1 flex items-center gap-1">
                        <i data-feather="lock" class="w-4 h-4 text-blue-400"></i>
                        Confirmar contraseña
                    </label>
                    <input type="password" id="admin_password_confirm" name="admin_password_confirm" required class="mt-1 block w-full border-blue-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base px-4 py-2">
                </div>

                <div class="flex justify-end mt-6">
                    <button type="submit" class="flex items-center gap-2 px-5 py-2 rounded-full font-semibold text-white bg-blue-500 shadow hover:bg-cyan-500 transition-all duration-200 text-lg">
                        <i data-feather="arrow-right" class="w-5 h-5"></i>
                        Siguiente
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function showFormError(message) {
        const errorDiv = document.getElementById('formError');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }
    function clearFormError() {
        const errorDiv = document.getElementById('formError');
        errorDiv.textContent = '';
        errorDiv.classList.add('hidden');
    }
    document.getElementById('adminForm').addEventListener('submit', function(event) {
        event.preventDefault();
        clearFormError();
        const username = document.getElementById('admin_username').value;
        const email = document.getElementById('admin_email').value;
        const pass = document.getElementById('admin_password').value;
        const pass2 = document.getElementById('admin_password_confirm').value;
        if (!username || !email || !pass || !pass2) {
            showFormError('Por favor, completa todos los campos.');
            return;
        }
        if (pass !== pass2) {
            showFormError('Las contraseñas no coinciden.');
            return;
        }
        const formData = new FormData();
        formData.append('admin_username', username);
        formData.append('admin_email', email);
        formData.append('admin_password', pass);
        formData.append('admin_password_confirm', pass2);
        $.ajax({
            url: '/admin',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    window.location.href = response.redirect || '/config';
                } else {
                    showFormError(response.error || 'Error desconocido.');
                }
            },
            error: function(xhr) {
                let msg = 'Error al guardar los datos.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    msg = xhr.responseJSON.error;
                }
                showFormError(msg);
            }
        });
    });

    // Validación visual de contraseña segura para el wizard admin
    const adminPasswordInput = document.getElementById('admin_password');
    const adminRequirements = [
        { regex: /.{8,}/, selector: 'li:nth-child(1)' },
        { regex: /[A-Z]/, selector: 'li:nth-child(2)' },
        { regex: /[a-z]/, selector: 'li:nth-child(3)' },
        { regex: /[0-9]/, selector: 'li:nth-child(4)' },
        { regex: /[^a-zA-Z0-9]/, selector: 'li:nth-child(5)' }
    ];
    if (adminPasswordInput) {
        adminPasswordInput.addEventListener('input', function() {
            const value = adminPasswordInput.value;
            adminRequirements.forEach(req => {
                const li = adminPasswordInput.parentElement.querySelector(req.selector);
                if (li) {
                    if (req.regex.test(value)) {
                        li.classList.add('text-green-600');
                        li.classList.remove('text-gray-500');
                    } else {
                        li.classList.remove('text-green-600');
                        li.classList.add('text-gray-500');
                    }
                }
            });
        });
    }
</script>
{% endblock %}