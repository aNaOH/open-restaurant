{% extends "/templates/base.php.twig" %}

{% block title %}Carro de la mesa {{order.table}}{% endblock %}

{% block content %}
    {% include "/components/header.php.twig" %}
    <div class="max-w-2xl mx-auto mt-8 w-full">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Finalizar pedido</h1>
        <div id="checkout-messages" class="mb-4"></div>
        <form id="payment-form" class="bg-white rounded-xl shadow p-6 border border-blue-100 flex flex-col gap-4">
            <label class="font-semibold text-gray-700">Datos de la tarjeta</label>
            <div id="card-element" class="border border-blue-200 rounded-lg px-4 py-3 bg-gray-50"></div>
            <button id="pay-btn" type="submit" class="mt-4 px-5 py-2 rounded-full font-semibold text-white bg-green-600 hover:bg-green-700 transition-all">Pagar pedido</button>
        </form>
        <div id="payment-success" class="hidden mt-6 p-4 bg-green-50 border border-green-200 text-green-800 rounded-lg text-center font-semibold"></div>
    </div>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
    let stripe, elements, card;
    document.addEventListener('DOMContentLoaded', async function() {
        stripe = Stripe('{{ stripe_public_key|e('js') }}'); // Usar clave pública de config
        elements = stripe.elements();
        card = elements.create('card', { style: { base: { fontSize: '16px', color: '#1e293b' } } });
        card.mount('#card-element');

        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            document.getElementById('pay-btn').disabled = true;
            document.getElementById('checkout-messages').textContent = '';
            // 1. Solicita el client_secret al backend
            let clientSecret;
            try {
                const res = await fetch('/order/create-stripe', { method: 'POST' });
                const data = await res.json();
                clientSecret = data.client_secret;
            } catch (err) {
                document.getElementById('checkout-messages').textContent = 'Error al iniciar el pago.';
                document.getElementById('pay-btn').disabled = false;
                return;
            }
            // 2. Confirma el pago con Stripe
            const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
                payment_method: { card: card }
            });
            if (error) {
                document.getElementById('checkout-messages').textContent = error.message;
                document.getElementById('pay-btn').disabled = false;
            } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                document.getElementById('payment-success').textContent = '¡Pago realizado con éxito!';
                document.getElementById('payment-success').classList.remove('hidden');
                form.style.display = 'none';
            }
        });
    });
    </script>
{% endblock %}